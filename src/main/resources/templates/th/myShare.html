<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{/css/customer.css}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <title>myShare</title>
</head>

<body>
<header>
    <th:blcok th:insert="~{th/customerHeader::header(user)}"></th:blcok>
</header>

<section>
    <aside>
        <ul>
            <li><a href="#myShare-tradeList">내 교환 등록 리스트</a></li>
            <li><a href="#myShare-receiveTradeRequestList">교환 신청 받은 책 리스트</a></li>
            <li><a href="#myShare-makeTradeRequestList">교환 신청한 책 리스트</a></li>
            <li><a th:href="@{/user/my-trade-status}">교환 상태</a></li>
        </ul>
    </aside>

    <div id="MyShareLogo">
        <div>
            <img src="../images/newFullLogo.png " alt="Logo">
        </div>
        <div>
            <h1>My Share</h1>
        </div>
    </div>

    <div id="myShareBox">
        <!--내 교환 등록 리스트-->
        <div id="myShare-tradeList">
            <div id="myShare-tradeList-title">
                <h1>내 교환 등록 리스트</h1> <!--상의 교환 진행중(메시지 보냈던거)인거 나오는가 아닌가-->
            </div>
            <div id="myShare-tradeList-contents">
                <th:block th:if="${tradeList ==null || tradeList.isEmpty()}">
                    <div>교환 등록한 책이 없습니다.</div>
                </th:block>
                <th:block th:unless="${tradeList ==null || tradeList.isEmpty()}">
                    <th:blcok th:each="trade:${tradeList}">
                        <div id="myShare-tradeList-content">
                            <div id="myShare-tradeList-content-imgbox">
                                <img th:src="${trade.book != null ? trade.book.image : '/images/noBook.jpg'}" alt=""
                                     style="height: 120px; width: 80px;">
                            </div>
                            <div id="myShare-tradeList-content-infobox">
                                <div>
                                    <p>도서명: <span th:text="${trade.book != null ? trade.book.name : 'Unknown'}"></span>
                                    </p>
                                </div>
                                <div>
                                    <p>작가: <span th:text="${trade.book != null ? trade.book.author : 'Unknown'}"></span>
                                    </p>
                                </div>
                                <div>
                                    <p>출판사: <span
                                            th:text="${trade.book != null ? trade.book.publisher : 'Unknown'}"></span>
                                    </p>
                                </div>
                            </div>
                            <div id="myShare-tradeList-content-delButtonBox">
                                <button id="myShare-tradeList-content-delButton" th:onclick="deleteBookTrade('[[${trade.bookTrade.book_trade_id}]]')">삭 제</button>
                            </div>
                        </div>
                    </th:blcok>
                </th:block>
            </div>
            <div id="myShare-tradeList-pagingArea">

            </div>
        </div>

        <div id="myShare-receiveTradeRequestList">
            <div id="myShare-receiveTradeRequestList-title">
                <h1>
                    교환 신청 받은 책 리스트
                </h1>
            </div>
            <div id="myShare-receiveTradeRequestList-contents">
                <th:block th:if="${receiveTradeRequestList == null || receiveTradeRequestList.isEmpty()}">
                    <div>교환 신청받은 책이 없습니다.</div>
                </th:block>
                <th:block th:unless="${receiveTradeRequestList == null || receiveTradeRequestList.isEmpty()}">
                    <th:block th:each="receiveTradeRequest : ${receiveTradeRequestList}">
                        <div id="myShare-receiveTradeRequestList-content" class="move-to-msg" th:msg-id="${receiveTradeRequest.msgId}">
                            <div>
                                <img th:src="${receiveTradeRequest.receivedBook != null ? receiveTradeRequest.receivedBook.image : '/images/noBook.jpg'}"
                                     alt="" style="height: 120px; width: 80px;">
                            </div>
                            <div>
                                <p>도서명: <span th:text="${receiveTradeRequest.receivedBook.name}"></span></p>
                                <p>작가: <span th:text="${receiveTradeRequest.receivedBook.author}"></span></p>
                                <p>출판사: <span th:text="${receiveTradeRequest.receivedBook.publisher}"></span></p>
                            </div>
                        </div>
                    </th:block>
                </th:block>
            </div>
            <div id="myShare-receiveTradeRequestList-pagingArea">

            </div>
        </div>

        <!--교환 신청한 책 리스트-->
        <div id="myShare-makeTradeRequestList">
            <div id="myShare-makeTradeRequestList-title">
                <h1>
                    교환 신청한 책 리스트
                </h1>
            </div>
            <div id="myShare-makeTradeRequestList-contents">
                <th:block th:if="${makeTradeRequestList == null || makeTradeRequestList.isEmpty()}">
                    <div>교환 신청한 책이 없습니다.</div>
                </th:block>
                <th:block th:unless="${makeTradeRequestList == null || makeTradeRequestList.isEmpty()}">
                    <th:block th:each="makeTradeRequest:${makeTradeRequestList}">
                        <div id="myShare-makeTradeRequestList-content" class="move-to-msg" th:msg-id="${makeTradeRequest.msgId}">
                            <div>
                                <img th:src="${makeTradeRequest.sentBook != null ? makeTradeRequest.sentBook.image : '/images/noBook.jpg'}"
                                     alt="" style="height: 120px; width: 80px;">
                            </div>
                            <div>
                                <div>
                                    <p>도서명: <span th:text="${makeTradeRequest.sentBook.name}"></span></p>
                                </div>
                                <div>
                                    <p>작가: <span th:text="${makeTradeRequest.sentBook.author}"></span></p>
                                </div>
                                <div>
                                    <p>출판사: <span th:text="${makeTradeRequest.sentBook.publisher}"></span></p>
                                </div>
                            </div>
                        </div>
                    </th:block>
                </th:block>
            </div>
            <div id="myShare-makeTradeRequestList-pagingArea">

            </div>
        </div>
    </div>
</section>
<footer>
    <th:blcok th:insert="~{th/footer}"></th:blcok>
</footer>
</body>
<script th:inline="javascript">
    <!-- 사이드바 클릭시 실행되는 함수   -->
    // 페이지가 로드될 때 실행되는 함수
    window.onload = function () {
        // 사이드바의 링크를 클릭할 때 실행되는 함수
        document.querySelectorAll('aside a').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                // "교환 상태" 링크가 아닌 경우에만 스크롤 실행
                if (!this.getAttribute('href').startsWith('#')) {
                    return;
                }
                e.preventDefault(); // 기본 이벤트(링크 이동)를 중지
                const targetId = this.getAttribute('href'); // 클릭한 링크의 href 속성 값(목표 ID) 가져오기
                const targetElement = document.querySelector(targetId); // 목표 ID에 해당하는 요소 찾기
                if (targetElement) {
                    // 목표 요소가 있는 경우에만 스크롤
                    targetElement.scrollIntoView({behavior: 'smooth'}); // 목표 요소로 스크롤
                }
            });
        });
    };

    document.addEventListener('DOMContentLoaded', function () {
        let listAreaContents = document.querySelectorAll('.move-to-msg');
        listAreaContents.forEach(function (moveMsg) {
            moveMsg.addEventListener('click', function () {
                let msgId = this.getAttribute('msg-id');
                window.location.href = '/user/msg-detail?id=' + encodeURIComponent(msgId);
            });
        });
    });

    const deleteBookTrade = (id) => {
        console.log("deleteBookTrade - " + id);

        $.ajax({
            url: '/user/delete-book-trade',
            method: 'Post',
            data: {id:id},
            success: function (response) {
                if (response){
                    consolde.log(response);
                    document.location.reload(true);
                    alert('해당 항목이 삭제되었습니다.')
                }else {
                    alert('해당 항목이 삭제되지 않았습니다. 교환이 진행되고 있다면 삭제할 수 없습니다.')
                }
            },
            error: function(){
                alert('서버와의 통신 중 문제가 발생했습니다.');
            }
        });
    };

</script>

</html>